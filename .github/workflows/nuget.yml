name: Nuget Upload

on:
  release: 
    types: 
      - published
  workflow_dispatch: 
        
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Setup TCLI
        run: dotnet tool install --global tcli

      - name: Setup dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
            
      # Install Mono on Ubuntu to run nuget.exe (due to this issue on Ubuntu 24 that hasn't been fixed yet - https://github.com/NuGet/setup-nuget/issues/168)
      - name: Install Mono on Ubuntu
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-transport-https dirmngr gnupg ca-certificates
          sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
          echo "deb https://download.mono-project.com/repo/ubuntu stable-focal main" | sudo tee /etc/apt/sources.list.d/mono-official-stable.list
          sudo apt-get update
          sudo apt-get install -y mono-complete

      - name: Build and Publish
        run: |
          dotnet pack --configuration Release /p:PackageOutputPath=./ReleaseOutput /p:OutputPath=./ReleaseOutput
          
          nuget setapikey "${{ secrets.NUGET_API_KEY }}"
          nuget push ./ReleaseOutput/*.nupkg -Source 'https://api.nuget.org/v3/index.json'
          find . -name '*.nupkg' -type f -delete
          
          find . -name '*.pdb' -type f -delete
          find . -name '*.deps.json' -type f -delete
          
          tcli publish --token ${{ secrets.TCLI_AUTH_TOKEN }}
          rm -rf ./build
          
          rm -rf ./ReleaseOutput